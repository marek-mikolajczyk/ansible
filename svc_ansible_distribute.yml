---
- name: distribute svc_ansible
  hosts: all:&infra
  vars:
    ssh_key:  !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30373665343961633136646438346263333936646431383762616465336364633935343731646139
          3939643466326533653162303737666139343564343437660a633563396232633437353233646137
          62383737326634393332633435393036386366323266653065393035373066383065343636393031
          3538373337353562320a383839326662303439663739613966666332613833626331323034383630
          34373363303365626566333033333236393837373739363236383234306639663636346638616234
          32343135393363623762353764323662393732343835643834613666313930316132316230613538
          30306434346534346533303539663337333433356136643036373734663864613239356661396637
          31343335313633343538633163363165343761373864643339353562363639393032663431333233
          35643161306136383631333639613763396636313431323733336466326130313161383264356630
          34376137363737643932643562666336316431306435326638386339643665396136396261323164
          31343361333338353561626633303537333639383163653030643166613133366239643262373763
          31363033303036393532313563393133353833323161306365666263616131353230393337633466
          38383334373661363932383161386164393566326661396530636566633633343937626264323931
          30326263323436393836326435316165366262373365393738386439366434636534346231323236
          61376138636233656331393839363562646264376166353431393166646335613636653762663633
          33363836366535333333663135303766333366363562373932653133336561366630643466633861
          64333964316632613166343233353462303966623533346165626164356535303162656466653066
          64626364326662353865663636393039373434636133383738626332343966613961376437316163
          61326431353733613436633534643031373962356364646163386637333261306365343661333562
          62646134316231373063663232346264653662323761326262663261636533333666623738376636
          64343732306565613937333730376433636265643437636165653561343235356335353862663565
          35376438636166323035356531396133663830383736323531666336373438303139343864643065
          62663131613632616664346532333635323832663066346239666639653032303730363839303631
          64323837356534396663663038363736353461303364663434393662396361343739636362636139
          32646232343064613939333734646562616133376435316664643363626130383661
  user: root
  gather_facts: True
  tasks:

    - name: add group
      group:
        gid: 2000
        name: svc_ansible
        state: present

    - name: add svc_account
      user:
        name: svc_ansible
        uid: 2000
        group: svc_ansible
        state: present

    - name: clean old sudo
      file:
        path: /etc/sudoers.d/svc_ansible
        state: absent

    - name: add sudo
      lineinfile:
        create: yes
        path: /etc/sudoers.d/svc_ansible
        regex: "^svc_ansible"
        line: 'svc_ansible    ALL=(ALL)       NOPASSWD: ALL'
        validate: 'visudo -cf %s'

    - name: create ssh dir
      file:
        path: /home/svc_ansible/.ssh
        owner: svc_ansible
        group: svc_ansible
        mode: 0700
        state: directory

    - name: add user key
      lineinfile:
        create: yes
        path: /home/svc_ansible/.ssh/authorized_keys
        line: "{{ ssh_key }}"
